class DiscountPackages extends HTMLElement{constructor(){super(),this.total=0,this.itemCount=1,this.product={},this.products=[],this.selectedProducts=[],this.selections=[];const t=document.getElementById("dp-template").content.cloneNode(!0);this.appendChild(t);const e=JSON.parse(this.getAttribute("package"));console.log("data",e);const i=JSON.parse(this.getAttribute("product-id"));this.products=e.products.sort((t,e)=>t.id===i?-1:e.id===i?1:0),this.product=this.products[0],this.products=this.products.slice(1),this.itemCount=e.itemCount,this.discount=e.discount,this.selectedItemCount=2,this.selectedProducts=[this.product,this.products[0]],this.selections=[{product:this.product,variant:this.product.variants[0],quantity:1},{product:this.products[0],variant:this.products[0].variants[0],quantity:1}],this.querySelector(".package__add-to-cart").addEventListener("click",t=>{this.addToCart(t)})}render(){this.updateCount(),this.updatePrice();const t=document.getElementById("dp-product"),e=this.querySelector("[data-product-single]"),i=this.querySelector("[data-product-list]");if(this.setupProduct(this.product,t,e,!0),this.products.forEach((e,s)=>this.setupProduct(e,t,i,0===s)),this.discount.enabled){const t=this.querySelector("[data-package-discount]"),e="percentage"===this.discount.type?`${this.discount.value}%`:window.theme.Currency.formatMoney(100*this.discount.value);t.innerText=e,t.classList.add(this.discount.type)}else this.querySelector(".package__discount-message").style.display="none"}updateRender(){this.updateCount(),this.updatePrice()}setupProduct(t,e,i,s){if(!t.available)return;const d=e.content.cloneNode(!0),a=d.querySelector("[data-product]"),n=d.querySelector("[data-product-image]"),r=d.querySelector("[data-product-title]"),c=d.querySelector("[data-product-price]"),o=d.querySelector("[data-quantity]"),u=Array.from(d.querySelectorAll("[data-quantity-toggle]")),l=d.querySelector("[data-product-checkbox]"),h=d.querySelector("[data-product-variant-selector]"),p=d.querySelector("[data-add-input]");a.setAttribute("data-product",t.id),n.src=this.getSizedImage(t.featured_image,{width:500}),r.innerText=t.title,c.innerText=window.theme.Currency.formatMoney(t.variants[0].price),p.name=`items[${t.variants[0].id}]`,s&&(l.checked=!0,o.disabled=!1,h.disabled=!1,p.disabled=!1),t.variants.forEach((t,e)=>{const i=document.createElement("option");i.value=t.id,i.innerText=t.title,0===e&&(i.selected=!0),h.appendChild(i)}),1===t.variants.length?h.style.opacity=0:h.addEventListener("input",e=>{const i=parseInt(e.target.value,10),s=t.variants.find(t=>t.id===i);c.innerText=window.theme.Currency.formatMoney(s.price),n.src=this.getSizedImage(s.featured_image.src,{width:500}),p.name=`items[${i}]`;const d=this.selections.findIndex(({product:e})=>e.id===t.id);-1!==d&&(this.selections[d]={...this.selections[d],variant:s},this.updateRender())}),u.forEach(e=>{e.addEventListener("click",e=>{let i=parseInt(o.value,10)+parseInt(e.target.dataset.quantityToggle,10);i<o.min&&(i=parseInt(o.min,10)),o.value=i,p.value=i;const s=this.selections.findIndex(({product:e})=>e.id===t.id);-1!==s&&(this.selections[s]={...this.selections[s],quantity:i},this.updateRender())})}),l.addEventListener("input",e=>{e.target.checked?(this.selectedProducts.push(t),this.selections.push({product:t,variant:t.variants[0],quantity:parseInt(o.value,10)}),h.disabled=!1,o.disabled=!1,p.disabled=!1):(this.selectedProducts=this.selectedProducts.filter(e=>e.id!==t.id),this.selections=this.selections.filter(({product:e})=>e.id!==t.id),h.disabled=!0,o.disabled=!0,p.disabled=!0),this.selectedItemCount=this.selectedProducts.length,this.updateRender()});const m=d.querySelector("[data-product-quickview]");m&&m.classList.add(`js-modal-open-quick-modal-${t.id}`),i.appendChild(d),m&&theme.preloadProductModal(t.handle,t.id,m)}addToCart(t){t.preventDefault();const e=t.target.closest("form");this.discount.enabled?fetch(`/discount/${window.atob(this.discount.code)}`).then(()=>{this.formSubmit(e)}):this.formSubmit(e)}getFormData(t){const e=new FormData(t);let i=[];for(const t of e.entries()){const e={id:t[0].replace("items[","").replace("]",""),quantity:t[1],properties:{_DiscountPackages:!0}};i.push(e)}return i}formSubmit(t){const e=this.getFormData(t);fetch(window.theme.routes.cartAdd,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:e})}).then(t=>t.json()).then(t=>console.log(t)).catch(console.error)}updateCount(){const t=this.querySelector(".package__item-count"),e=this.querySelector(".package__info--discount"),i=this.querySelector(".package__info--minimum"),s=this.selections.reduce((t,{quantity:e})=>t+e,0);t.innerText=`${s} ${s>1?"items":"item"}`,this.discount.enabled&&this.selectedItemCount<this.discount.min_quantity?(e&&e.classList.add("hide"),i&&i.classList.remove("hide")):(e&&e.classList.remove("hide"),i&&i.classList.add("hide"))}updatePrice(){const t=this.getOriginalTotalPrice(),e=this.getTotalPrice(),i=this.querySelector(".package__total-compare"),s=this.querySelector(".package__total-amount");e<t&&i&&(i.innerText=window.theme.Currency.formatMoney(t)),s.innerText=window.theme.Currency.formatMoney(e)}getOriginalTotalPrice(){return this.selections.reduce((t,{variant:e,quantity:i})=>t+e.price*i,0)}getTotalPrice(){return this.selections.reduce((t,{variant:e,quantity:i})=>{if(!this.discount.enabled||this.selectedProducts.length<this.discount.min_quantity)return t+e.price*i;let s=e.price*i;return"percentage"===this.discount.type&&(s-=s*(this.discount.value/100)),"fixed_amount"===this.discount.type&&(s-=this.discount.value*i),t+s},0)}getSizedImage(t,{width:e,height:i}){let s=t;return e&&(s+=`&width=${e}`),i&&(s+=`&height=${i}`),s}connectedCallback(){document.addEventListener("DOMContentLoaded",()=>this.render())}}window.customElements.define("discount-packages",DiscountPackages);